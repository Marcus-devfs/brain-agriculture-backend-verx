name: Deploy app to AWS EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH key
        run: |
          echo "ðŸ”‘ Salvando a chave SSH"
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem
          echo "âœ… Chave SSH configurada"

      - name: Add EC2 to known hosts
        run: |
          echo "ðŸ” Adicionando EC2 Ã  lista de hosts conhecidos"
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… Host adicionado"

      - name: Cleanup old containers and app folder on EC2
        run: |
          echo "ðŸ§¹ Limpando containers e volumes parados e removendo app antigo no EC2"
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            echo "ðŸ§¹ Limpando containers e volumes Docker..."
            docker system prune -af --volumes
            echo "ðŸ§¹ Removendo arquivos antigos da aplicaÃ§Ã£o..."
            rm -rf /home/ubuntu/app/*
            echo "âœ… Limpeza concluÃ­da"
          EOF

      - name: Install rsync
        run: |
          echo "ðŸ“¦ Instalando rsync para transferÃªncia eficiente de arquivos"
          sudo apt-get update && sudo apt-get install -y rsync
          echo "âœ… rsync instalado"

      - name: Sync project files to EC2
        run: |
          echo "ðŸš€ Sincronizando arquivos para o EC2"
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
            ./ ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/app
          echo "âœ… SincronizaÃ§Ã£o concluÃ­da"

      - name: Run Docker Compose on EC2
        run: |
          echo "ðŸ³ Subindo containers Docker no EC2"
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/app
            echo "â¬‡ï¸ Parando containers antigos"
            docker-compose down
            echo "â¬†ï¸ Subindo containers com build atualizado"
            docker-compose up --build -d
            echo "âœ… Containers rodando"
          EOF
